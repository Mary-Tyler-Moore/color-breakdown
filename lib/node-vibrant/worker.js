function rgbToHsl(t,e,n){t/=255,e/=255,n/=255;let i,o,s=Math.max(t,e,n),r=Math.min(t,e,n),l=(s+r)/2;if(s===r)i=o=0;else{let h=s-r;switch(o=l>.5?h/(2-s-r):h/(s+r),s){case t:i=(e-n)/h+(e<n?6:0);break;case e:i=(n-t)/h+2;break;case n:i=(t-e)/h+4}i/=6}return[i,o,l]}const SIGBITS=5,RSHIFT=8-SIGBITS;function rgbToHex(t,e,n){return"#"+((1<<24)+(t<<16)+(e<<8)+n).toString(16).slice(1,7)}function getColorIndex(t,e,n){return(t<<2*SIGBITS)+(e<<SIGBITS)+n}class Swatch{static applyFilter(t,e){return"function"==typeof e?t.filter(({r:t,g:n,b:i})=>e(t,n,i,255)):t}get r(){return this._rgb[0]}get g(){return this._rgb[1]}get b(){return this._rgb[2]}getRgb(){return this._rgb}getHsl(){if(!this._hsl){let[t,e,n]=this._rgb;this._hsl=rgbToHsl(t,e,n)}return this._hsl}getPopulation(){return this._population}getHex(){if(!this._hex){let[t,e,n]=this._rgb;this._hex=rgbToHex(t,e,n)}return this._hex}getYiq(){if(!this._yiq){let t=this._rgb;this._yiq=(299*t[0]+587*t[1]+114*t[2])/1e3}return this._yiq}getTitleTextColor(){return this.getYiq()<200?"#fff":"#000"}getBodyTextColor(){return this.getYiq()<150?"#fff":"#000"}constructor(t,e){this._rgb=t,this._population=e}}class VBox{constructor(t,e,n,i,o,s,r){this._volume=-1,this._count=-1,this.dimension={r1:t,r2:e,g1:n,g2:i,b1:o,b2:s},this.hist=r}static build(t,e){let n,i,o,s,r,l,h,u,f,c,a=new Uint32Array(1<<3*SIGBITS);n=o=r=0,i=s=l=Number.MAX_VALUE;let _=t.length/4,p=0;for(;p<_;){let e=4*p;(p++,h=t[e+0],u=t[e+1],f=t[e+2],0!==(c=t[e+3]))&&(a[getColorIndex(h>>=RSHIFT,u>>=RSHIFT,f>>=RSHIFT)]+=1,h>n&&(n=h),h<i&&(i=h),u>o&&(o=u),u<s&&(s=u),f>r&&(r=f),f<l&&(l=f))}return new VBox(i,n,s,o,l,r,a)}invalidate(){this._volume=this._count=-1,this._avg=null}volume(){if(this._volume<0){let{r1:t,r2:e,g1:n,g2:i,b1:o,b2:s}=this.dimension;this._volume=(e-t+1)*(i-n+1)*(s-o+1)}return this._volume}count(){if(this._count<0){let{hist:t}=this,{r1:e,r2:n,g1:i,g2:o,b1:s,b2:r}=this.dimension,l=0;for(let h=e;h<=n;h++)for(let e=i;e<=o;e++)for(let n=s;n<=r;n++){l+=t[getColorIndex(h,e,n)]}this._count=l}return this._count}clone(){let{hist:t}=this,{r1:e,r2:n,g1:i,g2:o,b1:s,b2:r}=this.dimension;return new VBox(e,n,i,o,s,r,t)}avg(){if(!this._avg){let e,n,i,{hist:o}=this,{r1:s,r2:r,g1:l,g2:h,b1:u,b2:f}=this.dimension,c=0,a=1<<8-SIGBITS;e=n=i=0;for(let _=s;_<=r;_++)for(let s=l;s<=h;s++)for(let r=u;r<=f;r++){var t=o[getColorIndex(_,s,r)];c+=t,e+=t*(_+.5)*a,n+=t*(s+.5)*a,i+=t*(r+.5)*a}this._avg=c?[~~(e/c),~~(n/c),~~(i/c)]:[~~(a*(s+r+1)/2),~~(a*(l+h+1)/2),~~(a*(u+f+1)/2)]}return this._avg}contains(t){let[e,n,i]=t,{r1:o,r2:s,g1:r,g2:l,b1:h,b2:u}=this.dimension;return n>>=RSHIFT,i>>=RSHIFT,(e>>=RSHIFT)>=o&&e<=s&&n>=r&&n<=l&&i>=h&&i<=u}split(){let{hist:t}=this,{r1:e,r2:n,g1:i,g2:o,b1:s,b2:r}=this.dimension,l=this.count();if(!l)return[];if(1===l)return[this.clone()];let h,u,f=n-e+1,c=o-i+1,a=r-s+1,_=Math.max(f,c,a),p=null;h=u=0;let g=null;if(_===f){g="r",p=new Uint32Array(n+1);for(let l=e;l<=n;l++){h=0;for(let e=i;e<=o;e++)for(let n=s;n<=r;n++){h+=t[getColorIndex(l,e,n)]}u+=h,p[l]=u}}else if(_===c){g="g",p=new Uint32Array(o+1);for(let l=i;l<=o;l++){h=0;for(let i=e;i<=n;i++)for(let e=s;e<=r;e++){h+=t[getColorIndex(i,l,e)]}u+=h,p[l]=u}}else{g="b",p=new Uint32Array(r+1);for(let l=s;l<=r;l++){h=0;for(let s=e;s<=n;s++)for(let e=i;e<=o;e++){h+=t[getColorIndex(s,e,l)]}u+=h,p[l]=u}}let d=-1,I=new Uint32Array(p.length);for(let t=0;t<p.length;t++){let e=p[t];d<0&&e>u/2&&(d=t),I[t]=u-e}let x=this;return function(t){let e=t+"1",n=t+"2",i=x.dimension[e],o=x.dimension[n],s=x.clone(),r=x.clone(),l=d-i,h=o-d;for(l<=h?(o=Math.min(o-1,~~(d+h/2)),o=Math.max(0,o)):(o=Math.max(i,~~(d-1-l/2)),o=Math.min(x.dimension[n],o));!p[o];)o++;let u=I[o];for(;!u&&p[o-1];)u=I[--o];return s.dimension[n]=o,r.dimension[e]=o+1,[s,r]}(g)}}class PQueue{constructor(t){this._comparator=t,this.contents=[],this._sorted=!1}_sort(){this._sorted||(this.contents.sort(this._comparator),this._sorted=!0)}push(t){this.contents.push(t),this._sorted=!1}peek(t){return this._sort(),t="number"==typeof t?t:this.contents.length-1,this.contents[t]}pop(){return this._sort(),this.contents.pop()}size(){return this.contents.length}map(t){return this._sort(),this.contents.map(t)}}const fractByPopulations=.75;function _splitBoxes(t,e){let n=t.size();for(;t.size()<e;){let e=t.pop();if(!(e&&e.count()>0))break;{let[i,o]=e.split();if(t.push(i),o&&o.count()>0&&t.push(o),t.size()===n)break;n=t.size()}}}const MMCQ=(t,e)=>{if(0===t.length||e.colorCount<2||e.colorCount>256)throw new Error("Wrong MMCQ parameters");let n=VBox.build(t),i=n.hist,o=(Object.keys(i).length,new PQueue((t,e)=>t.count()-e.count()));o.push(n),_splitBoxes(o,.75*e.colorCount);let s=new PQueue((t,e)=>t.count()*t.volume()-e.count()*e.volume());return s.contents=o.contents,_splitBoxes(s,e.colorCount-s.size()),generateSwatches(s)};function generateSwatches(t){let e=[];for(;t.size();){let n=t.pop(),i=n.avg();e.push(new Swatch(i,n.count()))}return e}self.onmessage=(t=>{let e,n=t.data,{id:i,payload:o}=n;try{e={id:i,type:"return",payload:MMCQ(o.pixels,o.opts)}}catch(t){e={id:i,type:"error",payload:t.message}}self.postMessage(e)});
//# sourceMappingURL=worker.js.map
